<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the spinning wheel and modals */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .wheel-container {
            position: relative;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 8px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .wheel-slice {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }
        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #ef4444; /* red-500 */
        }
    </style>
    <script src='//libtl.com/sdk.js' data-zone='9671872' data-sdk='show_9671872'></script>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <div id="app-container" class="max-w-md mx-auto p-4 space-y-6">
        <!-- Header Card -->
        <div class="bg-gray-800 rounded-xl p-5 text-center shadow-lg">
            <h1 class="text-xl font-bold text-cyan-400">Your Balance</h1>
            <p class="text-4xl font-mono font-bold mt-2"><span id="points-display">0</span> Points</p>
        </div>

        <!-- Main Actions Card -->
        <div class="bg-gray-800 rounded-xl p-5 shadow-lg space-y-4">
            <h2 class="text-lg font-semibold mb-3 text-center">Main Actions</h2>
            <button id="watch-ad-btn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.55a2 2 0 010 3.1l-4.55 2.55M4 12h11" /></svg>
                Watch Ad (+5 Points)
            </button>
            <button id="refer-btn" class="w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.975" /></svg>
                Refer a Friend (+10 Points)
            </button>
        </div>

        <!-- More Ways to Earn Card -->
        <div class="bg-gray-800 rounded-xl p-5 shadow-lg space-y-4">
             <h2 class="text-lg font-semibold mb-3 text-center">Bonus Rewards</h2>
            <button id="spin-earn-btn" class="w-full flex items-center justify-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Spin and Earn
            </button>
            <button id="guide-btn" class="w-full flex items-center justify-center bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                How to Income Guide
            </button>
        </div>

        <!-- Withdraw Card -->
        <div class="bg-gray-800 rounded-xl p-5 shadow-lg">
             <h2 class="text-lg font-semibold mb-3 text-center">Withdraw</h2>
            <button id="withdraw-btn" class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                Withdraw Now
            </button>
        </div>
    </div>

    <!-- Spin and Earn Modal -->
    <div id="spin-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl text-center w-11/12 max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Spin the Wheel!</h2>
            <p class="text-gray-400 mb-6">You can spin once every 2 hours.</p>
            <div class="relative flex items-center justify-center mb-6">
                <div class="wheel-pointer"></div>
                <div id="wheel" class="wheel-container">
                    <!-- Slices will be generated by JS -->
                </div>
            </div>
            <p id="spin-result" class="text-xl font-bold h-8 mb-4"></p>
            <button id="spin-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md disabled:bg-gray-500 disabled:cursor-not-allowed">
                Spin
            </button>
            <button id="close-spin-modal" class="mt-4 text-gray-400 hover:text-white">Close</button>
        </div>
    </div>

    <!-- How to Income Guide Modal -->
    <div id="guide-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl w-11/12 max-w-lg max-h-[80vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-center">How to Income Guide</h2>
            <div class="space-y-4 text-gray-300">
                <div>
                    <h3 class="font-semibold text-lg text-cyan-400">Earning Rules (English)</h3>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong>Watch Ad:</strong> Click to watch an ad and earn 5 points instantly.</li>
                        <li><strong>Refer a Friend:</strong> Share your link. You get 10 points for each new user who joins.</li>
                        <li><strong>Spin and Earn:</strong> Spin the wheel every 2 hours to win random points.</li>
                        <li><strong>Withdrawal:</strong> You need at least 50 points and 5 referrals to withdraw.</li>
                    </ul>
                </div>
                <hr class="border-gray-600">
                <div>
                    <h3 class="font-semibold text-lg text-cyan-400">আয়ের নিয়মাবলী (Bangla)</h3>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong>বিজ্ঞাপন দেখুন:</strong> বিজ্ঞাপনে ক্লিক করে तुरंत ৫ পয়েন্ট উপার্জন করুন।</li>
                        <li><strong>বন্ধু রেফার করুন:</strong> আপনার লিঙ্ক শেয়ার করুন। প্রতিটি নতুন ব্যবহারকারীর জন্য আপনি ১০ পয়েন্ট পাবেন।</li>
                        <li><strong>স্পিন এবং উপার্জন:</strong> প্রতি ২ ঘন্টা পর পর চাকা ঘুরিয়ে র‍্যান্ডম পয়েন্ট জিতে নিন।</li>
                        <li><strong>উত্তোলন:</strong> টাকা তোলার জন্য আপনার কমপক্ষে ৫০ পয়েন্ট এবং ৫টি রেফারেল প্রয়োজন।</li>
                    </ul>
                </div>
            </div>
            <button id="close-guide-modal" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>

    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="module">
        // --- Firebase SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDi3Xb3xPk_7bxG0brh85a_KiR80DApWPo",
            authDomain: "xspin-income-bot.firebaseapp.com",
            projectId: "xspin-income-bot",
            storageBucket: "xspin-income-bot.firebasestorage.app",
            messagingSenderId: "784212385666",
            appId: "1:784212385666:web:827eca0781e2441b14399b",
            measurementId: "G-R328XD7019"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        document.addEventListener('DOMContentLoaded', () => {
            // --- Telegram Web App Initialization ---
            const tg = window.Telegram.WebApp;
            tg.ready();

            // --- Mock User for Local Testing ---
            // Comment this out when deploying
            // const currentUser = { id: 123456789, first_name: "Test", username: "testuser" };

            // Use real Telegram user data
            const currentUser = tg.initDataUnsafe?.user;

            if (!currentUser) {
                document.getElementById('app-container').innerHTML = '<p class="text-center text-red-500">Could not retrieve user data. Please open this app through Telegram.</p>';
                return;
            }

            const userId = String(currentUser.id);
            const userRef = doc(db, 'users', userId);

            // --- App State ---
            let userState = {
                points: 0,
                referrals: 0,
                lastSpinTime: null
            };

            // --- UI Elements ---
            const pointsDisplay = document.getElementById('points-display');
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const referBtn = document.getElementById('refer-btn');
            const spinEarnBtn = document.getElementById('spin-earn-btn');
            const guideBtn = document.getElementById('guide-btn');
            const withdrawBtn = document.getElementById('withdraw-btn');

            // Modals
            const spinModal = document.getElementById('spin-modal');
            const guideModal = document.getElementById('guide-modal');
            const closeSpinModalBtn = document.getElementById('close-spin-modal');
            const closeGuideModalBtn = document.getElementById('close-guide-modal');

            // Spin Wheel
            const wheel = document.getElementById('wheel');
            const spinBtn = document.getElementById('spin-btn');
            const spinResult = document.getElementById('spin-result');
            const wheelPoints = [3, 20, 5, 40, 10, 25, 15, 5]; // 8 slices
            const sliceColors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f'];

            // --- Main App Initialization ---
            async function initApp() {
                tg.expand(); // Expand the app to full height
                await handleReferral();
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists()) {
                    // Create new user
                    const newUser = {
                        points: 0,
                        referrals: 0,
                        lastSpinTime: null,
                        firstName: currentUser.first_name,
                        username: currentUser.username || '',
                        createdAt: Timestamp.fromDate(new Date())
                    };
                    await setDoc(userRef, newUser);
                    userState = newUser;
                } else {
                    userState = docSnap.data();
                }
                updateUI();
            }

            // --- UI Update Function ---
            function updateUI() {
                pointsDisplay.innerText = userState.points || 0;
            }

            // --- Monetag Ad ---
            function triggerMonetagAd() {
                console.log("Attempting to show rewarded ad...");
                window.show_9671872('pop').then(() => {
                    // Ad was watched successfully
                    console.log("Ad watched successfully. Awarding points.");
                    updateUserPoints(userState.points + 5);
                    tg.showAlert('You have been awarded 5 points!');
                }).catch(e => {
                    // An error occurred
                    console.error("Error showing ad: ", e);
                    tg.showAlert('Sorry, an error occurred while showing the ad. Please try again.');
                });
            }

            // --- Feature Logic ---
            function updateUserPoints(newPoints, newReferrals = userState.referrals) {
                userState.points = newPoints;
                userState.referrals = newReferrals;
                updateDoc(userRef, { points: newPoints, referrals: newReferrals })
                    .then(updateUI)
                    .catch(e => console.error("Error updating points: ", e));
            }

            async function handleReferral() {
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('ref');
                if (!referrerId || referrerId === userId) return;

                const docSnap = await getDoc(userRef);
                // Only give referral points if the user is new
                if (!docSnap.exists()) {
                    const referrerRef = doc(db, 'users', referrerId);
                    const referrerDoc = await getDoc(referrerRef);
                    if (referrerDoc.exists()) {
                        await updateDoc(referrerRef, {
                            points: increment(10),
                            referrals: increment(1)
                        });
                        console.log(`Credited 10 points to referrer ${referrerId}`);
                    }
                }
            }

            function referFriend() {
                const repoUrl = "https://YOUR_GITHUB_USERNAME.github.io/YOUR_REPO_NAME/";
                const referralLink = `${repoUrl}?ref=${userId}`;
                tg.showPopup({
                    title: 'Your Referral Link',
                    message: `Share this link with your friends. You will get 10 points for each new user who joins!\n\n${referralLink}`,
                    buttons: [{id: 'copy', type: 'default', text: 'Copy Link'}, {type: 'cancel'}]
                }, (buttonId) => {
                    if (buttonId === 'copy') {
                        navigator.clipboard.writeText(referralLink).then(() => {
                           tg.showAlert('Link copied to clipboard!');
                        });
                    }
                });
            }

            function openSpinModal() {
                const twoHours = 2 * 60 * 60 * 1000;
                const lastSpin = userState.lastSpinTime ? userState.lastSpinTime.toDate() : null;
                const now = new Date();

                if (lastSpin && (now - lastSpin < twoHours)) {
                    const timeLeft = twoHours - (now - lastSpin);
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    tg.showAlert(`You can spin again in ${hours}h ${minutes}m.`);
                    return;
                }

                generateWheelSlices();
                spinResult.innerText = '';
                spinBtn.disabled = false;
                spinModal.classList.remove('hidden');
            }

            function generateWheelSlices() {
                wheel.innerHTML = '';
                wheelPoints.forEach((points, i) => {
                    const rotation = (360 / wheelPoints.length) * i;
                    const slice = document.createElement('div');
                    slice.className = 'wheel-slice';
                    slice.style.transform = `rotate(${rotation}deg)`;
                    slice.style.backgroundColor = sliceColors[i % sliceColors.length];

                    const text = document.createElement('span');
                    text.style.transform = `rotate(45deg) translate(-20px, -20px)`;
                    text.innerText = points;
                    slice.appendChild(text);
                    wheel.appendChild(slice);
                });
            }

            function spinTheWheel() {
                spinBtn.disabled = true;
                spinResult.innerText = "Spinning...";

                const totalSlices = wheelPoints.length;
                const sliceAngle = 360 / totalSlices;
                const randomSlice = Math.floor(Math.random() * totalSlices);
                const winningPoints = wheelPoints[randomSlice];

                const spinOffset = (randomSlice * sliceAngle) + (sliceAngle / 2);
                const randomSpins = 5 * 360; // Spin at least 5 times
                const finalRotation = randomSpins + spinOffset;

                wheel.style.transform = `rotate(${finalRotation}deg)`;

                setTimeout(() => {
                    spinResult.innerText = `You won ${winningPoints} points!`;
                    const newLastSpinTime = Timestamp.fromDate(new Date());
                    userState.lastSpinTime = newLastSpinTime;
                    updateDoc(userRef, {
                        points: increment(winningPoints),
                        lastSpinTime: newLastSpinTime
                    });
                    // Manually update local state for points since increment doesn't return new value
                    userState.points += winningPoints;
                    updateUI();
                }, 4500); // Wait for animation to finish
            }

            function withdraw() {
                const requiredPoints = 50;
                const requiredReferrals = 5;

                if (userState.points < requiredPoints || userState.referrals < requiredReferrals) {
                    tg.showAlert(`Withdrawal failed. You need at least ${requiredPoints} points and ${requiredReferrals} referrals. You have ${userState.points} points and ${userState.referrals} referrals.`);
                    return;
                }

                tg.showConfirm(`Are you sure you want to withdraw 50 points?`, (confirmed) => {
                    if (confirmed) {
                        const newPoints = userState.points - 50;
                        updateUserPoints(newPoints);

                        // Log withdrawal request
                        addDoc(collection(db, 'withdrawals'), {
                            userId: userId,
                            username: currentUser.username || '',
                            pointsWithdrawn: 50,
                            timestamp: Timestamp.fromDate(new Date())
                        });

                        tg.showAlert('Withdrawal request successful! 50 points have been deducted.');
                    }
                });
            }

            // --- Event Listeners ---
            watchAdBtn.addEventListener('click', triggerMonetagAd);
            referBtn.addEventListener('click', referFriend);
            withdrawBtn.addEventListener('click', withdraw);

            // Modals
            spinEarnBtn.addEventListener('click', openSpinModal);
            guideBtn.addEventListener('click', () => guideModal.classList.remove('hidden'));
            closeSpinModalBtn.addEventListener('click', () => spinModal.classList.add('hidden'));
            closeGuideModalBtn.addEventListener('click', () => guideModal.classList.add('hidden'));

            // Spin Wheel
            spinBtn.addEventListener('click', spinTheWheel);

            // --- Start the app ---
            initApp();
        });
    </script>
</body>
</html>
